<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="A few pointers / examples for using the Bitbucket Server API (the API syntax for Bitbucket Cloud might differ in some cases). API authentication Accessing Bitbucket through its API using curl...">
        <meta name="keywords" content="api, atlassian, bash, bitbucket, curl">
        <link rel="icon" href="https://0x7df.github.io/favicon.ico">

        <title>Using the Atlassian Bitbucket API - 0x7df</title>

        <!-- Stylesheets -->
        <link href="https://0x7df.github.io/theme/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://0x7df.github.io/theme/css/fonts.css" rel="stylesheet">
        <link href="https://0x7df.github.io/theme/css/nest.css" rel="stylesheet">
        <link href="https://0x7df.github.io/theme/css/pygment.css" rel="stylesheet">
        <!-- /Stylesheets -->

        <!-- RSS Feeds -->
        <link href="https://0x7df.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="0x7df Full Atom Feed" />
        <!-- /RSS Feeds -->

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->



    </head>

    <body>

        <!-- Header -->
    <div class="header-container gradient">

            <!-- Static navbar -->
            <div class="container">
                <div class="header-nav">
                    <div class="header-logo">
                        <a class="pull-left" href="https://0x7df.github.io/"><img class="mr20" src="https://0x7df.github.io/images/0x7df_60x60.png" alt="logo">0x7df</a>
                    </div>
                    <div class="nav pull-right">
                                <a href="https://0x7df.github.io/">Blog Home</a>
                                <a href="http://0x7df.io">Site Home</a>
                                <a href="https://0x7df.github.io/categories.html">Categories</a>
                            <a  href="https://0x7df.github.io/pages/0x7df-application.html">0x7df application</a>
                            <a  href="https://0x7df.github.io/pages/about.html">About</a>
                    </div>
                </div>
            </div>
            <!-- /Static navbar -->

            <!-- Header -->
    <!-- Header -->
    <div class="container header-wrapper">
        <div class="row">
              <div class="col-lg-12">
                  <div class="header-content">
                      <h1 class="header-title">Using the Atlassian Bitbucket API</h1>
                      <p class="header-date">By <a href="https://0x7df.github.io/author/0x7df.html">0x7df</a>, Mon 27 February 2017, modified Mon 27 February 2017, in category <a href="https://0x7df.github.io/category/programming.html">Programming</a></p>
                      <div class="header-underline"></div>
                      <div class="clearfix"></div>
                      <p class="pull-right header-tags">
                          <span class="glyphicon glyphicon-tags mr5" aria-hidden="true"></span>
<a href="https://0x7df.github.io/tag/api.html">api</a>, <a href="https://0x7df.github.io/tag/atlassian.html">atlassian</a>, <a href="https://0x7df.github.io/tag/bash.html">bash</a>, <a href="https://0x7df.github.io/tag/bitbucket.html">bitbucket</a>, <a href="https://0x7df.github.io/tag/curl.html">curl</a>                      </p>
                  </div>
              </div>
        </div>
    </div>
    <!-- /Header -->
            <!-- /Header -->

        </div>
        <!-- /Header -->


        <!-- Content -->
    <div class="container content">
        <p>A few pointers / examples for using the Bitbucket Server API (the API syntax
for Bitbucket Cloud might differ in some cases).</p>
<h2>API authentication</h2>
<p>Accessing Bitbucket through its API using curl requires username/password
authentication. Using:</p>
<div class="highlight"><pre><span></span><code>curl -u &lt;username&gt;:&lt;password&gt; ...
</code></pre></div>

<p>is no good in a script if the script is intended to be used by several people.
Just:</p>
<div class="highlight"><pre><span></span><code>curl -u &lt;username&gt; ...
</code></pre></div>

<p>is better, as the password is then requested by curl and can be entered
by the user at the command line. However, the password is requested each time
curl is used in the script, which makes it irritating if there are several
calls in the script. The
solution is to record the password in a 'netrc' file, and then point curl to
this. If the file is called <code>.netrc</code> and stored in the user's home directory,
then the <code>-n</code> / <code>--netrc</code> option can be used. The syntax of the file is:</p>
<div class="highlight"><pre><span></span><code><span class="err">machine &lt;host.domain.com&gt; login &lt;username&gt; password &lt;password&gt;</span>
</code></pre></div>

<p>The same <code>.netrc</code> file can hold lines for multiple hosts, so it would be fine
to add a line for Bitbucket to an existing <code>.netrc</code> or to create it if it
didn't already exist. However to keep it simpler I chose to create a dedicated
netrc file and point to it with the <code>--netrc-file</code> option (available in curl
from 7.21.5 onwards), which allows an arbitrary path/name for the netrc file.</p>
<h2>SSH key</h2>
<p>If access to Bibucket via SSH is required, then the user needs to add an SSH
key to their account. Using the API, we can do:</p>
<div class="highlight"><pre><span></span><code>curl --netrc-file <span class="s2">&quot;</span><span class="nv">$NETRC_FILE</span><span class="s2">&quot;</span> -o json.tmp <span class="s2">&quot;</span><span class="si">${</span><span class="nv">URL</span><span class="si">}</span><span class="s2">/ssh/1.0/keys&quot;</span>
</code></pre></div>

<p>to get any SSH keys already associated with the user's Bitbucket account,
where we have stored the full path to the authentication file discussed above
in the variable <code>$NETRC_FILE</code>, and the URL to the Bitbucket server in <code>$URL</code>.
The data returned by the API call gets stored in a file called <code>json.tmp</code>.</p>
<p>We can pretty-print the JSON data returned by the Bitbucket API using:</p>
<div class="highlight"><pre><span></span><code>cat json.tmp <span class="p">|</span> python -m json.tool
</code></pre></div>

<p>from which it's easy to extract the SSH key returned and match it against the
user's SSH key(s) in <code>${HOME}/.ssh</code>.</p>
<p>If there's no match, then we can take an existing key (or create one with
<code>ssh-keygen</code>) and post it using:</p>
<div class="highlight"><pre><span></span><code>curl --netrc-file <span class="s2">&quot;</span><span class="nv">$NETRC_FILE</span><span class="s2">&quot;</span> -i -H <span class="s2">&quot;Content-Type:application/json&quot;</span> <span class="se">\</span>
     -X POST --data <span class="s1">&#39;{&quot;text&quot;: &quot;&#39;</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SSH_KEY</span><span class="si">}</span><span class="s2">&quot;</span><span class="s1">&#39;&quot;}&#39;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">URL</span><span class="si">}</span><span class="s2">/ssh/1.0/keys&quot;</span>
</code></pre></div>

<p>Here we have already stored the SSH key we want to post in the <code>$SSH_KEY</code>
variable. The <code>-i</code> flag includes the HTTP header in the output, and the <code>-H</code>
option includes the argument that follows it as an extra header in the request
that curl sends. The <code>-X</code> option is used to specify that curl should use the
'POST' method; this is actually redundant since the use of <code>--data</code> implies
use of a 'POST' request.</p>
<p>(As an aside, the annoying:</p>
<div class="highlight"><pre><span></span><code><span class="err">X11 forwarding request failed on channel 0</span>
</code></pre></div>

<p>message when using SSH can be suppressed by adding:</p>
<div class="highlight"><pre><span></span><code><span class="err">Host &lt;URL&gt; [&lt;URL&gt; ...]</span>
<span class="err">  ForwardX11 no</span>
</code></pre></div>

<p>to the <code>$HOME/.ssh/config</code> file.)</p>
<h2>Forking a repository</h2>
<p>To check whether a repository <code>$REPO_NAME</code> exists in <code>$USER</code>'s personal space:</p>
<div class="highlight"><pre><span></span><code>curl --netrc-file <span class="se">\</span>
     <span class="s2">&quot;</span><span class="nv">$NETRC_FILE</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">URL</span><span class="si">}</span><span class="s2">/api/1.0/projects/~</span><span class="si">${</span><span class="nv">USER</span><span class="si">}</span><span class="s2">/repos/</span><span class="si">${</span><span class="nv">REPO_NAME</span><span class="si">}</span><span class="s2">&quot;</span> <span class="se">\</span>
     <span class="p">|</span> grep <span class="s2">&quot;\&quot;name\&quot;:\&quot;</span><span class="si">${</span><span class="nv">REPO_NAME</span><span class="si">}</span><span class="s2">\&quot;&quot;</span>
</code></pre></div>

<p>and to create a user fork of a Bitbucket repository <code>$REPO_NAME</code> under project
<code>$PROJECT</code>:</p>
<div class="highlight"><pre><span></span><code>curl --netrc-file <span class="s2">&quot;</span><span class="nv">$NETRC_FILE</span><span class="s2">&quot;</span> -X POST -H <span class="s2">&quot;Content-Type:application/json&quot;</span>
     --data <span class="s1">&#39;{}&#39;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">URL</span><span class="si">}</span><span class="s2">/api/1.0/projects/</span><span class="si">${</span><span class="nv">PROJECT</span><span class="si">}</span><span class="s2">/repos/</span><span class="si">${</span><span class="nv">REPO_NAME</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>

<h2>Changing repository permissions and settings</h2>
<p>Changing permissions can also be done via the API:</p>
<div class="highlight"><pre><span></span><code>curl --netrc-file <span class="s2">&quot;</span><span class="nv">$NETRC_FILE</span><span class="s2">&quot;</span> -X PUT <span class="se">\</span>
     <span class="s2">&quot;</span><span class="si">${</span><span class="nv">URL</span><span class="si">}</span><span class="s2">/api/1.0/projects/~</span><span class="si">${</span><span class="nv">USER</span><span class="si">}</span><span class="s2">/repos/</span><span class="si">${</span><span class="nv">REPO_NAME</span><span class="si">}</span><span class="s2">/permissions/groups?permission=REPO_READ&amp;name=</span><span class="si">${</span><span class="nv">USER_NAME</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>

<p>In this example a repository <code>$REPO_NAME</code> in <code>$USER</code>'s personal space has had
read permission added for <code>$USER_NAME</code> (which could also be the name of a
group defined on Bitbucket).</p>
<p>An example of changing a setting:</p>
<div class="highlight"><pre><span></span><code>curl --netrc-file <span class="s2">&quot;</span><span class="nv">$NETRC_FILE</span><span class="s2">&quot;</span> -X POST  -H <span class="s2">&quot;Content-Type:application/json&quot;</span> <span class="se">\</span>
     --data <span class="s1">&#39;{&quot;type&quot;:&quot;fast-forward-only&quot;,&quot;matcher&quot;:{&quot;id&quot;:&quot;*&quot;,&quot;type&quot;:{&quot;id&quot;:&quot;PATTERN&quot;}}}&#39;</span> <span class="se">\</span>
     <span class="s2">&quot;</span><span class="si">${</span><span class="nv">URL</span><span class="si">}</span><span class="s2">/branch-permissions/2.0/projects/~</span><span class="si">${</span><span class="nv">USER</span><span class="si">}</span><span class="s2">/repos/</span><span class="si">${</span><span class="nv">REPO_NAME</span><span class="si">}</span><span class="s2">/restrictions&quot;</span>
</code></pre></div>

<p>Here we've added protection against re-writing history to all branches. In
the web interface to Bitbucket we would do this in 'Settings' / 'Branch
permissions' by clicking the 'Add permissions' button. We can add permissions
to a specific branch, a 'branch pattern' (which allows the use of wildcards),
or according to the branching model. The <code>"matcher"</code> key in the data posted to
the API specifies that we want to use the 'branch pattern' mode of specifying
branches, and that we want the branch pattern itself to be '*' - i.e. we want
to apply the permission to all branches in the repository. The permission
itself is 'fast-forward-only', which corresponds to 'Prevent rewriting
history'.</p>


        <h3 id="comments">Comments</h3>

        <div class="form-style">
            <h3>Add comment</h3>
            <form method="POST" action="https://comment-bot-0x7df.herokuapp.com/v2/entry/0x7df/0x7df.github.io/source/comments">
                    <input    name="options[redirect]" type="hidden" value="https://0x7df.github.io/using-the-atlassian-bitbucket-api">
                    <input    name="fields[url]"       type="hidden" value="using-the-atlassian-bitbucket-api">
                    <input    name="fields[name]"      type="text" placeholder="Name">
                    <textarea name="fields[message]"               placeholder="Comment"></textarea>
                    <input    name="submit"            type="submit" value="Submit"/>
            </form>
        </div>


    </div>
        <!-- /Content --> 

        <!-- Footer -->
        <div class="footer gradient-2">
            <div class="container footer-container ">
                <div class="row">
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Sitemap</div>
                        <ul class="list-unstyled">
                            <li><a href="https://0x7df.github.io/archives.html">Archives</a></li>
                            <li><a href="https://0x7df.github.io/tags.html">Tags</a></li>
                            <li><a href="https://0x7df.github.io/authors.html">Authors</a></li>
                            <li><a href="https://0x7df.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">Atom Feed</a></li>
                        </ul>
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Social</div>
                        <ul class="list-unstyled">
                            <li><a href="https://twitter.com/@0x7df" target="_blank">Twitter</a></li>
                            <li><a href="https://github.com/0x7df" target="_blank">GitHub</a></li>
                            <li><a href="https://www.facebook.com/0x7df" target="_blank">Facebook</a></li>
                            <li><a href="https://stackoverflow.com/users/4802778" target="_blank">StackOverflow</a></li>
                            <li><a href="http://www.freecodecamp.com/0x7df" target="_blank">FreeCodeCamp</a></li>
                        </ul>
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Links</div>
                        <ul class="list-unstyled">
                            <li><a href="http://getpelican.com/" target="_blank">Pelican</a></li>
                            <li><a href="http://python.org/" target="_blank">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/" target="_blank">Jinja2</a></li>
                            <li><a href="https://github.com/barrysteyn/pelican_plugin-render_math" target="_blank">Maths plugin</a></li>
                            <li><a href="https://github.com/molivier/nest" target="_blank">Nest theme</a></li>
                            <li><a href="" target="_blank"></a></li>
                            <li><a href="" target="_blank"></a></li>
                            <li><a href="" target="_blank"></a></li>
                        </ul>
                    </div> 
                    <div class="col-xs-12 col-sm-3 col-md-3 col-lg-3">
                        <p class="pull-right text-right">
                            <small><em>Proudly powered by <a href="http://docs.getpelican.com/" target="_blank">pelican</a></em></small><br/>
                            <small><em>Theme and code by <a href="https://github.com/molivier" target="_blank">molivier</a></em></small><br/>
                            <small>&copy; 0x7df 2015</small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <!-- /Footer -->
    </body>
</html>