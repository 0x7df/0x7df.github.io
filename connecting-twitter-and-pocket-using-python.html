<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="This blog post gives an intro to connecting to the Twitter Streaming API using the Python library Tweepy. There are two Python routines: one to connect to Twitter and download relevant tweets to a ...">
        <meta name="keywords" content="api, pocket, python, twitter">
        <link rel="icon" href="http://0x7df.github.io/favicon.ico">

        <title>Connecting Twitter and Pocket using Python - 0x7df</title>

        <!-- Stylesheets -->
        <link href="http://0x7df.github.io/theme/css/all.min.css" rel="stylesheet">
        <!-- /Stylesheets -->

        <!-- RSS Feeds -->
        <link href="http://0x7df.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="0x7df Full Atom Feed" />
        <link href="http://0x7df.github.io/feeds/programming.atom.xml" type="application/atom+xml" rel="alternate" title="0x7df Categories Atom Feed" />
        <!-- /RSS Feeds -->

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->



    </head>

    <body>

        <!-- Header -->
    <div class="header-container gradient">

            <!-- Static navbar -->
            <div class="container">
                <div class="header-nav">
                    <div class="header-logo">
                        <a class="pull-left" href="http://0x7df.github.io/"><img class="mr20" src="http://0x7df.github.io/images/0x7df_60x60.png" alt="logo">0x7df</a>
                    </div>
                    <div class="nav pull-right">
                                <a href="http://0x7df.github.io/">Blog Home</a>
                                <a href="http://0x7df.io">Site Home</a>
                                <a href="http://0x7df.github.io/categories.html">Categories</a>
                            <a  href="http://0x7df.github.io/pages/0x7df-application.html">0x7df application</a>
                            <a  href="http://0x7df.github.io/pages/about.html">About</a>
                    </div>
                </div>
            </div>
            <!-- /Static navbar -->

            <!-- Header -->
    <!-- Header -->
    <div class="container header-wrapper">
        <div class="row">
              <div class="col-lg-12">
                  <div class="header-content">
                      <h1 class="header-title">Connecting Twitter and Pocket using Python</h1>
                      <p class="header-date">By <a href="http://0x7df.github.io/author/0x7df.html">0x7df</a>, Fri 23 October 2015, modified Fri 23 October 2015, in category <a href="http://0x7df.github.io/category/programming.html">Programming</a></p>
                      <div class="header-underline"></div>
                      <div class="clearfix"></div>
                      <p class="pull-right header-tags">
                          <span class="glyphicon glyphicon-tags mr5" aria-hidden="true"></span>
<a href="http://0x7df.github.io/tag/api.html">api</a>, <a href="http://0x7df.github.io/tag/pocket.html">pocket</a>, <a href="http://0x7df.github.io/tag/python.html">python</a>, <a href="http://0x7df.github.io/tag/twitter.html">twitter</a>                      </p>
                  </div>
              </div>
        </div>
    </div>
    <!-- /Header -->
            <!-- /Header -->

        </div>
        <!-- /Header -->


        <!-- Content -->
    <div class="container content">
        <p><a href="http://adilmoujahid.com/posts/2014/07/twitter-analytics/">This</a> blog post gives an intro to connecting to the Twitter Streaming
API using the <a href="https://python.org">Python</a> library <a href="http://tweepy.readthedocs.org">Tweepy</a>. There are two Python routines:
one to connect to Twitter and download relevant tweets to a file, and a
second to post-process the file using <a href="http://pandas.pydata.org/">Pandas</a> and create some graphs
using <a href="http://matplotlib.org">Matplotlib</a>.</p>
<p>In particular the scripts use <a href="https://en.wikipedia.org/wiki/Regular_expression">regular expressions</a> to identify tweets
that contain links, where those tweets have previously been filtered by
keywords such as 'python', 'javascript', 'tutorial', etc.</p>
<p>I liked the idea of extracting these links automatically, and thought about
going a step further and collecting those links in <a href="http://getpocket.com">Pocket</a>, using the
<a href="http://getpocket.com/developer/">Pocket API</a>.</p>
<p>None of this required the tweets to be written to a file first, so I adapted
the scripts to do everything in real time rather than post-processing, and
Pandas wasn't required.</p>
<p>The script needs to connect to the Pocket account using previously retrieved
credentials. It uses <a href="https://github.com/tapanpandita/pocket">pocket</a>, another Python library for
connecting to the Pocket API; an example of its use is <a href="https://w.wol.ph/2013/09/18/batch-adding-data-to-pocket/">here</a>.
My code for connecting to Pocket looks like this:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pocket</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;pocket_api_key.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fileHandle</span><span class="p">:</span>
    <span class="p">(</span><span class="n">pckt_consumer_key</span><span class="p">,</span> <span class="n">pckt_access_token</span><span class="p">,</span> <span class="n">redirect_uri</span><span class="p">)</span> <span class="o">=</span> \
        <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">fileHandle</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># Pocket authentication</span>
    <span class="n">pocket_instance</span> <span class="o">=</span> <span class="n">pocket</span><span class="o">.</span><span class="n">Pocket</span><span class="p">(</span><span class="n">pckt_consumer_key</span><span class="p">,</span> <span class="n">pckt_access_token</span><span class="p">)</span>
</pre></div>


<p>Next, I connect to the Twitter Streaming API using 
the <code>filter</code> method, which returns only tweets that contain certain pre-defined
keywords. This is straight from <a href="http://adilmoujahid.com/posts/2014/07/twitter-analytics/">the original post</a>.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tweepy.streaming</span> <span class="kn">import</span> <span class="n">StreamListener</span>
<span class="kn">from</span> <span class="nn">tweepy</span> <span class="kn">import</span> <span class="n">OAuthHandler</span>
<span class="kn">from</span> <span class="nn">tweepy</span> <span class="kn">import</span> <span class="n">Stream</span>

<span class="c1"># Read the Twitter API key data from a file (not in the repository)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;twitter_api_key.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fileHandle</span><span class="p">:</span>
    <span class="p">(</span><span class="n">access_token</span><span class="p">,</span> <span class="n">access_token_secret</span><span class="p">,</span> <span class="n">consumer_key</span><span class="p">,</span> <span class="n">consumer_secret</span><span class="p">)</span> <span class="o">=</span> \
        <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">fileHandle</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>

<span class="c1"># Set the keywords to filter the Twitter stream for</span>
<span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="s1">&#39;javascript&#39;</span><span class="p">,</span> <span class="s1">&#39;fortran&#39;</span><span class="p">,</span> <span class="s1">&#39;bash&#39;</span><span class="p">,</span> <span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="s1">&#39;css&#39;</span><span class="p">,</span>
            <span class="s1">&#39;jquery&#39;</span><span class="p">,</span> <span class="s1">&#39;api&#39;</span><span class="p">,</span> <span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;vim&#39;</span><span class="p">,</span> <span class="s1">&#39;julia&#39;</span><span class="p">]</span>

<span class="c1"># This is a basic listener that prints received tweets to stdout</span>
<span class="c1"># Over-ride the tweepy.Stream listener to provide methods</span>
<span class="k">class</span> <span class="nc">StdOutListener</span><span class="p">(</span><span class="n">StreamListener</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Create stream listener class for Twitter Streaming API.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">on_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process individual tweet.&quot;&quot;&quot;</span>
        <span class="n">myrespond</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">on_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle error from Twitter Streaming API.&quot;&quot;&quot;</span>
        <span class="k">print</span> <span class="n">status</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">420</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

        <span class="c1"># Handle Twitter authentication and connection to Twitter Streaming API</span>
        <span class="n">listener</span> <span class="o">=</span> <span class="n">StdOutListener</span><span class="p">()</span>
        <span class="n">auth</span> <span class="o">=</span> <span class="n">OAuthHandler</span><span class="p">(</span><span class="n">consumer_key</span><span class="p">,</span> <span class="n">consumer_secret</span><span class="p">)</span>
        <span class="n">auth</span><span class="o">.</span><span class="n">set_access_token</span><span class="p">(</span><span class="n">access_token</span><span class="p">,</span> <span class="n">access_token_secret</span><span class="p">)</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="n">Stream</span><span class="p">(</span><span class="n">auth</span><span class="p">,</span> <span class="n">listener</span><span class="p">)</span>

        <span class="c1"># Filter Twitter stream according to keywords</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">track</span><span class="o">=</span><span class="n">keywords</span><span class="p">)</span>
</pre></div>


<p>(Clearly the error-handling needs finishing.) Each tweet is processed by the
function <code>myrespond()</code>, which looks for tweets that also
contain the word 'tutorial', and extracts the link if there is one.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="k">def</span> <span class="nf">getdata</span><span class="p">(</span><span class="n">tweet</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get dictionary value given key.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">tweet</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
    <span class="k">return</span> <span class="n">val</span>

<span class="k">def</span> <span class="nf">word_in_text</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Search for work in text string.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">extract_link</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extract link from tweet or return null string.&quot;&quot;&quot;</span>
    <span class="n">regex</span> <span class="o">=</span> <span class="s1">r&#39;https?:..[^\s&lt;&gt;&quot;]+|www\.[^\s&lt;&gt;&quot;]+&#39;</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span>

<span class="k">def</span> <span class="nf">myrespond</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Respond to relevant tweet.&quot;&quot;&quot;</span>
    <span class="n">tweet</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">lang</span> <span class="o">=</span> <span class="n">getdata</span><span class="p">(</span><span class="n">tweet</span><span class="p">,</span> <span class="s1">&#39;lang&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;en&#39;</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">getdata</span><span class="p">(</span><span class="n">tweet</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span>
        <span class="n">link</span> <span class="o">=</span> <span class="n">extract_link</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">word_in_text</span><span class="p">(</span><span class="s1">&#39;tutorial&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span> <span class="ow">and</span> <span class="n">link</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">text</span>
            <span class="k">print</span> <span class="n">link</span>
            <span class="k">print</span> <span class="n">pocket_instance</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">link</span><span class="p">)</span>
            <span class="k">print</span> <span class="s2">&quot;-----------------------------------------------------------&quot;</span>
</pre></div>


<p>The <code>myrespond()</code> function uses the <code>json</code> library to turn the JSON-format data
containing the tweet into a Python dictionary, then another function <code>getdata</code>
to access individual data items; if the language is English, then the text of
the tweet is extracted and the <code>re</code> library used to return the link. Finally,
the Pocket API is used to add the link to Pocket.</p>
<p>There's probably some sophistication that could be added to this to ensure
better quality links are identified; I could, for example, use my own tweets
and blog posts as a reference corpus, and test the similarity of tweets
to the text in my corpus; and then only add links that have a similarity score
above some threshold.</p>
<p>The full code is on <a href="https://github.com">GitHub</a>, at
<a href="https://github.com/0x7df/twitter2pocket">https://github.com/0x7df/twitter2pocket</a>.</p>


        
    </div>
        <!-- /Content --> 

        <!-- Footer -->
        <div class="footer gradient-2">
            <div class="container footer-container ">
                <div class="row">
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Sitemap</div>
                        <ul class="list-unstyled">
                            <li><a href="http://0x7df.github.io/archives.html">Archives</a></li>
                            <li><a href="http://0x7df.github.io/tags.html">Tags</a></li>
                            <li><a href="http://0x7df.github.io/authors.html">Authors</a></li>
                            <li><a href="http://0x7df.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">Atom Feed</a></li>
                        </ul>
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Social</div>
                        <ul class="list-unstyled">
                            <li><a href="https://twitter.com/@0x7df" target="_blank">Twitter</a></li>
                            <li><a href="https://github.com/0x7df" target="_blank">GitHub</a></li>
                            <li><a href="https://www.facebook.com/0x7df" target="_blank">Facebook</a></li>
                            <li><a href="https://stackoverflow.com/users/4802778" target="_blank">StackOverflow</a></li>
                            <li><a href="http://www.freecodecamp.com/0x7df" target="_blank">FreeCodeCamp</a></li>
                        </ul>
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Links</div>
                        <ul class="list-unstyled">
                            <li><a href="http://getpelican.com/" target="_blank">Pelican</a></li>
                            <li><a href="http://python.org/" target="_blank">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/" target="_blank">Jinja2</a></li>
                            <li><a href="https://github.com/barrysteyn/pelican_plugin-render_math" target="_blank">Maths plugin</a></li>
                            <li><a href="https://github.com/molivier/nest" target="_blank">Nest theme</a></li>
                            <li><a href="" target="_blank"></a></li>
                            <li><a href="" target="_blank"></a></li>
                            <li><a href="" target="_blank"></a></li>
                        </ul>
                    </div> 
                    <div class="col-xs-12 col-sm-3 col-md-3 col-lg-3">
                        <p class="pull-right text-right">
                            <small><em>Proudly powered by <a href="http://docs.getpelican.com/" target="_blank">pelican</a></em></small><br/>
                            <small><em>Theme and code by <a href="https://github.com/molivier" target="_blank">molivier</a></em></small><br/>
                            <small>&copy; 0x7df 2015</small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <!-- /Footer -->
    </body>
</html>