<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="Overview OpenMP is a set of extensions to Fortran, C and C++, consisting of compiler directives, library routines, and environment variables, that allows the programming of shared-memory...">
        <meta name="keywords" content="">
        <link rel="icon" href="http://0x7df.github.io/favicon.ico">

        <title>OpenMP 1 - 0x7df</title>

        <!-- Stylesheets -->
        <link href="http://0x7df.github.io/theme/css/all.min.css" rel="stylesheet">
        <!-- /Stylesheets -->

        <!-- RSS Feeds -->
        <link href="http://0x7df.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="0x7df Full Atom Feed" />
        <link href="http://0x7df.github.io/feeds/misc.atom.xml" type="application/atom+xml" rel="alternate" title="0x7df Categories Atom Feed" />
        <!-- /RSS Feeds -->

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->



    </head>

    <body>

        <!-- Header -->
    <div class="header-container gradient">

            <!-- Static navbar -->
            <div class="container">
                <div class="header-nav">
                    <div class="header-logo">
                        <a class="pull-left" href="http://0x7df.github.io/"><img class="mr20" src="http://0x7df.github.io/images/0x7df_60x60.png" alt="logo">0x7df</a>
                    </div>
                    <div class="nav pull-right">
                                <a href="http://0x7df.github.io/">Blog Home</a>
                                <a href="http://0x7df.io">Site Home</a>
                                <a href="http://0x7df.github.io/categories.html">Categories</a>
                    </div>
                </div>
            </div>
            <!-- /Static navbar -->

            <!-- Header -->
    <!-- Header -->
    <div class="container header-wrapper">
        <div class="row">
              <div class="col-lg-12">
                  <div class="header-content">
                      <h1 class="header-title">OpenMP 1</h1>
                      <p class="header-date">By <a href="http://0x7df.github.io/author/0x7df.html">0x7df</a>, Mon 21 May 2018, modified Mon 21 May 2018, in category <a href="http://0x7df.github.io/category/misc.html">Misc</a></p>
                      <div class="header-underline"></div>
                      <div class="clearfix"></div>
                      <p class="pull-right header-tags">
                          <span class="glyphicon glyphicon-tags mr5" aria-hidden="true"></span>
                      </p>
                  </div>
              </div>
        </div>
    </div>
    <!-- /Header -->
            <!-- /Header -->

        </div>
        <!-- /Header -->


        <!-- Content -->
    <div class="container content">
        <h1>Overview</h1>
<p>OpenMP is a set of extensions to Fortran, C and C++, consisting of compiler
directives, library routines, and environment variables, that allows the
programming of shared-memory applications. Typically it allows parallelism to
be added to an existing application without a major re-write.</p>
<p>The OpenMP programming model is based on the notion of <em>threads</em>. Threads are
similar to processes, but as well as having their own private memory, they can
share memory with each other. Different threads can follow different logical
paths through the same code; each thread has its own program counter.</p>
<p>Usually there is one thread per core; there can be more but then the core has
to time-share between the threads, which introduces some overhead. In some
systems there is hardware support for multiple threads per core
(symmetric multithreading (SMT), also known as hyperthreading).</p>
<p>Unlike MPI, threads do not exchange information via messages, but simply via
reading and writing to shared memory.</p>
<p>By default, threads execute independently of each other; there is no
synchronisation. Therefore to ensure correctness, the programmer must ensure
that actions on shared data occur in the correct order. Note that an update to
a shared variable, e.g. <code>x = x + 1</code>, is not atomic. If there are two threads, the
correct result is <code>x + 2</code>, but it is possible for thread 1 to read <code>x</code>, and then
for thread 2 to read <code>x</code> before thread 1 has incremented the value and written it
back to <code>x</code>. The final result would be <code>x + 1</code>.</p>
<p>The most common OpenMP idiom is the parallelisation of loops, where the
iterations of the loop are independent of each other.</p>
<p>For example, in:</p>
<div class="highlight"><pre><span></span><span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">imax</span>
    <span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="k">end do</span>
</pre></div>


<p>the loop iterations are independent of each other and the loop can be parallelised, whereas:</p>
<div class="highlight"><pre><span></span><span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">imax</span>
    <span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> 
<span class="k">end do</span>
</pre></div>


<p>has a <em>loop-carried dependency</em>. The loop iterations must be done in the
correct order to obtain the correct result.</p>
<p>In the former case the loop iterations can be carried out in any order, and can
therefore be shared amongst a number of threads. If <code>imax = 100</code> and there are
two threads, we could do iterations 1-50 on thread 1 and 51-100 on thread 2,
giving essentially a factor of two increase. (In practive the overhead of
creating and managing the threads reduces, often drastically, the speedup.)</p>
<p>A <em>reduction</em> operation produces a single value from a set of values, e.g. the
sum, product, maximum, minimum, etc. For example, consider the loop: </p>
<div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="n">enddo</span>
</pre></div>


<p>For correctness we would need to ensure only one thread at a time incremented
<code>x</code>, which would destroy all the parallelism. It's better if each thread performs
its own private reduction, and then these per-thread results are reduced to the
final answer. If the number of threads is small relative to the number of
values being aggregated, then there is still substantial parallelism.</p>
<h1>Implementation</h1>
<p>OpenMP is implemented in source code by means of <em>compiler directives</em>; these are special
source code lines that are only meaningful to certain OpenMP-compliant compilers. Directives are
protected by a <em>sentinel</em>, which for OpenMP is:</p>
<ul>
<li><code>!$OMP</code> for Fortran</li>
<li><code>#pragma omp</code> for C/C++</li>
</ul>
<p>Clearly the directive appears as an ordinary comment and is therefore ignored by the
compiler if the compiler is not OpenMP-compliant, or if OpenMP is not requested.</p>
<p>For example:</p>
<div class="highlight"><pre><span></span><span class="k">program </span><span class="n">hello_world</span>
    <span class="c">!$OMP PARALLEL</span>
    <span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;Hello world!&quot;</span>
    <span class="c">!$OMP END PARALLEL</span>
<span class="k">end program </span><span class="n">hello_world</span>
</pre></div>


<p>To compile an OpenMP program, the addition of a (compiler-dependent) flag at
the compile and link steps makes OpenMP available. E.g. using GCC:</p>
<div class="highlight"><pre><span></span>$ gfortran -fopenmp -o hello_world hello_world.f95
</pre></div>


<p>OpenMP is built into most compilers. The flag for Intel compilers is <code>-openmp</code>.
OpenMP is on by default in the Cray compiler.</p>
<p>The number of threads at run-time is determined from an environment variable:</p>
<div class="highlight"><pre><span></span>$ <span class="nb">export</span> <span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">4</span>
</pre></div>


<p>(The default number of threads is implementation-dependent. It might be 1,
or it might be equal to the number of cores in the system.)</p>
<p>Then the application is run as normal:</p>
<div class="highlight"><pre><span></span>$ ./hello_world 
 Hello world!
 Hello world!
 Hello world!
 Hello world!
</pre></div>


<hr/>

<ul>
<li><a href="http://0x7df.github.io/openmp-1.html">OpenMP 1 (Overview, Implementaion)</a></li>
<li><a href="http://0x7df.github.io/openmp-2.html">OpenMP 2 (Parallel regions, OpenMP functions)</a></li>
<li><a href="http://0x7df.github.io/drafts/openmp-3.html">OpenMP 3 (OpenMP clauses)</a></li>
<li><a href="http://0x7df.github.io/drafts/openmp-4.html">OpenMP 4 (Reductions)</a></li>
<li><a href="http://0x7df.github.io/drafts/openmp-5.html">OpenMP 5 (Work-sharing constructs)</a></li>
<li><a href="http://0x7df.github.io/drafts/openmp-6.html">OpenMP 6 (Synchronisation)</a></li>
<li><a href="{filename}openmp-7.md">OpenMP 7 ()</a></li>
</ul>
<hr/>

<p>These notes are built on the "Hands-on Introduction to OpenMP" tutorial given at the UK OpenMP Users' Conference.</p>
<p>This work is licensed under a Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License.</p>
<p><a href="http://creativecommons.org/licenses/by-nc-sa/4.0/deed.en_US">http://creativecommons.org/licenses/by-nc-sa/4.0/deed.en_US</a></p>
<p>This means you are free to copy and redistribute the material and adapt and build on the
material under the following terms: you must give appropriate credit, provide a link to the license and indicate if changes were made. If you adapt or build on the material you must distribute your work under the same license as the original.</p>


        
    </div>
        <!-- /Content --> 

        <!-- Footer -->
        <div class="footer gradient-2">
            <div class="container footer-container ">
                <div class="row">
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Sitemap</div>
                        <ul class="list-unstyled">
                            <li><a href="http://0x7df.github.io/archives.html">Archives</a></li>
                            <li><a href="http://0x7df.github.io/tags.html">Tags</a></li>
                            <li><a href="http://0x7df.github.io/authors.html">Authors</a></li>
                            <li><a href="http://0x7df.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">Atom Feed</a></li>
                        </ul>
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Social</div>
                        <ul class="list-unstyled">
                            <li><a href="https://twitter.com/@0x7df" target="_blank">Twitter</a></li>
                            <li><a href="https://github.com/0x7df" target="_blank">GitHub</a></li>
                            <li><a href="https://www.facebook.com/0x7df" target="_blank">Facebook</a></li>
                            <li><a href="https://stackoverflow.com/users/4802778" target="_blank">StackOverflow</a></li>
                            <li><a href="http://www.freecodecamp.com/0x7df" target="_blank">FreeCodeCamp</a></li>
                        </ul>
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Links</div>
                        <ul class="list-unstyled">
                            <li><a href="http://getpelican.com/" target="_blank">Pelican</a></li>
                            <li><a href="http://python.org/" target="_blank">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/" target="_blank">Jinja2</a></li>
                            <li><a href="https://github.com/barrysteyn/pelican_plugin-render_math" target="_blank">Maths plugin</a></li>
                            <li><a href="https://github.com/molivier/nest" target="_blank">Nest theme</a></li>
                            <li><a href="" target="_blank"></a></li>
                            <li><a href="" target="_blank"></a></li>
                            <li><a href="" target="_blank"></a></li>
                        </ul>
                    </div> 
                    <div class="col-xs-12 col-sm-3 col-md-3 col-lg-3">
                        <p class="pull-right text-right">
                            <small><em>Proudly powered by <a href="http://docs.getpelican.com/" target="_blank">pelican</a></em></small><br/>
                            <small><em>Theme and code by <a href="https://github.com/molivier" target="_blank">molivier</a></em></small><br/>
                            <small>&copy; 0x7df 2015</small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <!-- /Footer -->
    </body>
</html>