<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="A recent blog post I came across introduced me to Prospector, a Pythonstatic analysis tool developed by Landscape. From the documentation: Prospector is a tool to analyse Python code and output ...">
        <meta name="keywords" content="cyclomatic complexity, graph theory, mccabe, pep8, prospector, pylint, python, static analysis, yaml">
        <link rel="icon" href="/favicon.ico">

        <title>Python code analysis using Prospector - 0x7df</title>

        <!-- Stylesheets -->
        <link href="/theme/css/all.min.css" rel="stylesheet">
        <!-- /Stylesheets -->

        <!-- RSS Feeds -->
        <!-- /RSS Feeds -->

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->



    </head>

    <body>

        <!-- Header -->
    <div class="header-container gradient">

            <!-- Static navbar -->
            <div class="container">
                <div class="header-nav">
                    <div class="header-logo">
                        <a class="pull-left" href="/"><img class="mr20" src="/images/0x7df_60x60_no-bg.png" alt="logo">0x7df</a>
                    </div>
                    <div class="nav pull-right">
                                <a href="/">Home</a>
                                <a href="/">Blog Home</a>
                                <a href="/categories.html">Categories</a>
                            <a  href="/pages/0x7df-application.html">0x7df application</a>
                            <a  href="/pages/about.html">About</a>
                    </div>
                </div>
            </div>
            <!-- /Static navbar -->

            <!-- Header -->
    <!-- Header -->
    <div class="container header-wrapper">
        <div class="row">
              <div class="col-lg-12">
                  <div class="header-content">
                      <h1 class="header-title">Python code analysis using Prospector</h1>
                      <p class="header-date">By <a href="/author/0x7df.html">0x7df</a>, Sat 11 April 2015, in category <a href="/category/programming.html">Programming</a></p>
                      <div class="header-underline"></div>
                      <div class="clearfix"></div>
                      <p class="pull-right header-tags">
                          <span class="glyphicon glyphicon-tags mr5" aria-hidden="true"></span>
<a href="/tag/cyclomatic-complexity.html">cyclomatic complexity</a>, <a href="/tag/graph-theory.html">graph theory</a>, <a href="/tag/mccabe.html">mccabe</a>, <a href="/tag/pep8.html">pep8</a>, <a href="/tag/prospector.html">prospector</a>, <a href="/tag/pylint.html">pylint</a>, <a href="/tag/python.html">python</a>, <a href="/tag/static-analysis.html">static analysis</a>, <a href="/tag/yaml.html">yaml</a>                      </p>
                  </div>
              </div>
        </div>
    </div>
    <!-- /Header -->
            <!-- /Header -->

        </div>
        <!-- /Header -->


        <!-- Content -->
    <div class="container content">
        <p>A <a href="https://blog.landscape.io/prospector-python-static-analysis-for-humans.html">recent blog
post</a>
I came across introduced me to
<a href="https://github.com/landscapeio/prospector">Prospector</a>, a
<a href="https://www.python.org/">Python</a><a href="http://en.wikipedia.org/wiki/Static_program_analysis">static
analysis</a> tool
developed by <a href="https://landscape.io/">Landscape</a>. From the
<a href="https://prospector.readthedocs.org">documentation</a>:</p>
<blockquote>
<p>Prospector is a tool to analyse Python code and output information
about errors, potential problems, convention violations and
complexity.</p>
<p>It brings together the functionality of other Python analysis tools
such as <a href="http://docs.pylint.org/">Pylint</a>,
<a href="http://pep8.readthedocs.org/en/latest/">pep8</a>, and <a href="https://pypi.python.org/pypi/mccabe">McCabe
complexity</a>.</p>
<p>The primary aim of Prospector is to be useful ‘out of the box’. A
common complaint of other Python analysis tools is that it takes a
long time to filter through which errors are relevant or interesting
to your own coding style. Prospector provides some default profiles,
which hopefully will provide a good starting point and will be useful
straight away, and adapts the output depending on the libraries your
project uses.</p>
</blockquote>
<p>So rather than configuring and individually using the various different
static analysis packages mentioned, and wading through the potentially
overwhelming output, Prospector provides a single interface to all of
them, and is set up to give a more manageable level of information
straight-away, without much user intervention. I won't repeat the sales
pitch and the basic how-to that <a href="https://blog.landscape.io/prospector-python-static-analysis-for-humans.html">that
post</a>
contains, but will go on from there to give a bit more information.</p>
<hr />
<h2>Cyclomatic complexity</h2>
<p>The first thing you might come across that might not be self-evident is
the complexity rating given by the
<a href="https://github.com/flintwork/mccabe"><code>mccabe</code></a> package. E.g.:</p>
<p>[code lang="bash"]</p>
<blockquote>
<p>prospector --strictness low<br />
Messages<br />
========</p>
</blockquote>
<p>main.py<br />
  Line: 13<br />
    mccabe: MC0001 / run is too complex (17)</p>
<h1>Check Information</h1>
<p>Started: 2015-04-11 15:59:47.759944<br />
       Finished: 2015-04-11 15:59:51.598176<br />
     Time Taken: 3.84 seconds<br />
      Formatter: grouped<br />
       Profiles: default, strictness_low, strictness_medium,
strictness_high, strictness_veryhigh, no_doc_warnings,
no_test_warnings, no_member_warnings<br />
     Strictness: low<br />
 Libraries Used:<br />
      Tools Run: dodgy, mccabe, pep8, profile-validator, pyflakes,
pylint<br />
 Messages Found: 1</p>
<p>[/code]</p>
<p>The <em>cyclomatic complexity</em> metric was defined by <a href="http://ieeexplore.ieee.org/xpl/articleDetails.jsp?arnumber=1702388&amp;filter%3DAND%28p_IS_Number%3A35895%29">Thomas J. McCabe in a
1976
paper</a>
(the PDF of which can be found
<a href="http://www.literateprogramming.com/mccabe.pdf">here</a>, or reproduced in
the <a href="https://books.google.co.uk/books?id=vtNWAAAAMAAJ&amp;dq=%22structured%20testing%22&amp;pg=PR1#v=onepage&amp;q=%22structured%20testing%22&amp;f=false">book "Structured Testing" which is available on Google
Books</a>).
It is essentially a measure of the number of logical paths through a
piece of source code: the higher the number, the higher the complexity,
and therefore the more error-prone the code is likely to be. McCabe
suggested "10... seems like a reasonable, but not magical, upper limit".
The example given above was found to have a complexity of 17, so needs
simplifying (e.g by breaking up into more than one routine).</p>
<p>For more detail, the McCabe paper gives a very good description which is
hard to improve on:</p>
<blockquote>
<p>Given a program we will associate with it a directed graph that has
unique entry and exit nodes [vertices]. Each node in the graph
corresponds to a block of code in the program where the flow is
sequential and the arcs [edges] correspond to branches taken in the
program. This graph is classically known as the program control
graph... and it is assumed that each node can be reached by the entry
node and each node can reach the exit node. For example the following
is a program control graph with entry node <span class="math">\( a\)</span> and
exit node <span class="math">\( f\)</span>:</p>
<p><img alt="Reproduced from McCabe (1976)" src="https://books.google.co.uk/books?id=vtNWAAAAMAAJ&amp;pg=PA3&amp;img=1&amp;zoom=3&amp;hl=en&amp;sig=ACfU3U2LbN62dSqC_xZCFeoYcb-COKZ7IA&amp;ci=642%2C968%2C254%2C220&amp;edge=0" /></p>
<p>The following mathematical preliminaries will be needed...</p>
<p><em>Definition 1</em>: The cyclomatic number <span class="math">\( V(G)\)</span> of a
graph <span class="math">\( G\)</span> with <span class="math">\( n\)</span> vertices,
<span class="math">\( e\)</span> edges and <span class="math">\( p\)</span> connected
components is</p>
<p>
<div class="math">$$ V(G) = e - n + p $$</div>
</p>
<p><em>Theorem 1</em>: In a strongly connected graph <span class="math">\( G\)</span> the
cyclomatic number is equal to the maximum number of linearly
independent circuits.</p>
</blockquote>
<p>Note here that at this stage we are concerned with <em>circuits</em> - i.e.
closed loops that start at a given node and return back to that same
node - rather than <em>paths</em>.</p>
<blockquote>
<p>Theorem 1 is applied to <span class="math">\( G\)</span> in the following way.
Imagine that the exit node <span class="math">\( f\)</span> branches back to the
entry node <span class="math">\( a\)</span>. The control graph <span class="math">\( G\)</span>
is now strongly connected (there is a path joining any
pair of arbitrary distinct vertices) so Theorem 1 applies. Therefore
the maximum number of linearly independent circuits in <span class="math">\( G\)</span>
is <span class="math">\( 9 - 6 + 2\)</span>. For example one could
choose the following 5 independent circuits in <span class="math">\( G\)</span>:</p>
<p>
<div class="math">$$ B1: (abefa), (beb), (abea), (acfa), (adcfa) $$</div>
</p>
<p>It follows that <span class="math">\( B1\)</span> forms a basis for the set of
all circuits in <span class="math">\( G\)</span> and any path through <span class="math">\( G\)</span>
can be expressed as a linear combination of circuits from
<span class="math">\( B1\)</span>. For instance the path <span class="math">\( (abeabebebef)\)</span>
is expressible as <span class="math">\( (abea) + 2(beb) + (abefa)\)</span>.</p>
<p>To see how this works it's necessary to number the edges on <span class="math">\( G\)</span>
as in:</p>
<p><img alt="Reproduced from McCabe, 1976." src="https://books.google.co.uk/books?id=vtNWAAAAMAAJ&amp;pg=PA4&amp;img=1&amp;zoom=3&amp;hl=en&amp;sig=ACfU3U2LMlgVCsIny0X682Rs8LVIkP0WqA&amp;ci=165%2C387%2C235%2C207&amp;edge=0" /></p>
<p>Now for each member of the basis <span class="math">\( B1\)</span> associate a
vector as follows:</p>
<p><img alt="Reproduced from McCabe, 1976." src="https://books.google.co.uk/books?id=vtNWAAAAMAAJ&amp;pg=PA4&amp;img=1&amp;zoom=3&amp;hl=en&amp;sig=ACfU3U2LMlgVCsIny0X682Rs8LVIkP0WqA&amp;ci=66%2C638%2C279%2C134&amp;edge=0" /></p>
<p>The path <span class="math">\( (abea(be)^3fa)\)</span> corresponds to the
vector <span class="math">\( 2004200111\)</span> and the vector addition of
<span class="math">\( (abefa)\)</span>, <span class="math">\( 2(beb)\)</span> and
<span class="math">\( (abea)\)</span> yields the desired result.</p>
<p>In using Theorem 1 one can choose a basis set of circuits that
correspond to paths through the program. The set <span class="math">\( B2\)</span>
is a basis of program paths.</p>
<p>
<div class="math">$$ B2: (abef), (abeabef), (abebef), (acf), (adcf) $$</div>
</p>
<p>Linear combination of paths in <span class="math">\( B2\)</span> will also
generate any path. For example:</p>
<p>
<div class="math">$$ (abea(be)^3f) = 2(abebef) - (abef) $$</div>
</p>
<p>and:</p>
<p>
<div class="math">$$ (a(be)^2(abef) = (a(be)^2f) + (abeabef) - (abef) $$</div>
</p>
<p>The overall strategy will be to measure the complexity of a program by
computing the number of linearly independent paths <span class="math">\( V(G)\)</span>,
control the size of programs by setting an upper limit
to <span class="math">\( V(G)\)</span> (instead of using just physical size),
and use the cyclomatic complexity as the basis for a testing
methodology.</p>
</blockquote>
<p>[caption id="attachment_450" align="alignleft" width="178"]<a href="https://0x7df.files.wordpress.com/2015/04/example_mccabe_graph.png"><img alt="Example
mccabe graph
output" src="https://0x7df.files.wordpress.com/2015/04/example_mccabe_graph.png?w=178" /></a>
Example mccabe graph output[/caption]</p>
<p>If you want to run <code>mccabe</code> separately from <code>prospector</code> you can do,
using:</p>
<p>[code lang="bash"]  </p>
<blockquote>
<p>python -m mccabe mysourcefile.py<br />
('If 209', 2)<br />
("13:1: 'run'", 8)<br />
[/code]</p>
</blockquote>
<p>You can add the <code>-d</code> option (documented
<a href="http://nedbatchelder.com/blog/200803/python_code_complexity_microtool.html">here</a>)
to produce output that can be passed to the
<a href="http://www.graphviz.org/">Graphviz</a> program
<a href="http://www.graphviz.org/pdf/dotguide.pdf">dot</a>, which will plot the
graph. I.e.:</p>
<p>[code lang="bash"]  </p>
<blockquote>
<p>python -m mccabe -d example.py | \<br />
dot -Tpng -o example.png<br />
[/code]</p>
</blockquote>
<p>produces something like the graph shown to the left.</p>
<p>As well as using the cyclomatic complexity as a metric of whether a
particular piece of source code needs simplifying, it can also give an
indication of the number of tests that are required. If the number of
tests is less than the complexity metric, then clearly there must be
some paths through that are not being tested. Obviously, it doesn't
necessarily follow that, if the number of tests is equal to or greater
than the complexity, then all paths <em>are</em> being tested - more than one
test might be following a particular logical path. So having
<span class="math">\( V(G)\)</span> tests for a particular routine <span class="math">\( G\)</span>
is necessary but not sufficient to ensure full coverage of all the
paths; but it seems like a good start.</p>
<h2>Fine-tuning using profiles in Prospector</h2>
<p>Probably one of the most useful aspects of Prospector is the ability to
fine-tune the warnings that are issued. For instance, once the
strictness level is up to medium or above, you might start to get a lot
of warnings from Pylint about invalid constant names:</p>
<p>[code]<br />
example.py<br />
Line: 1<br />
pylint: invalid-name / Invalid constant name "nmats"<br />
Line: 17<br />
pylint: invalid-name / Invalid constant name "dcoeff"<br />
Line: 21<br />
pylint: invalid-name / Invalid constant name "tpower"<br />
Line: 23<br />
pylint: invalid-name / Invalid constant name "tmp0"<br />
...<br />
[/code]</p>
<p>The <a href="https://www.python.org/dev/peps/pep-0008">PEP8 style guide</a>
suggests constants should be in upper case; I'm happy with this rule but
in most cases that were identified for a particular project I used a
trial run, I didn't regard the variable as a constant (e.g. like
<span class="math">\( \pi\)</span>, <span class="math">\( c\)</span>, <span class="math">\( h\)</span>,
etc.), but a variable that happens not to change - in a lot of the cases
just because the code is incomplete and, at some point down the line,
these will end up changing.</p>
<p>When we move to the <code>veryhigh</code> strictness level, another example that
comes up is trailing whitespace. I want to remove trailing whitespace
from lines of code; but because my editor automatically indents, <em>blank</em>
lines also get indented to the same level as the most recent non-blank
line. This whitespace on otherwise blank lines counts as trailing
whitespace, so I get far too many warning messages.</p>
<p>Thirdly, classes that have too few (fewer than two) public methods are
warned against; <a href="http://stackoverflow.com/questions/14027417/what-does-pylints-too-few-public-methods-message-mean">the advice is that classes shouldn't be used for data
storage, but should include
functions</a>.
If the only purpose is data storage, then a data structure  like a
dictionary is more appropriate. However, again because of the
work-in-progress status of the code being analysed, I've defined certain
classes that currently only register data, but I expect at some point
will include methods. So in the meantime I want to turn this check off,
for the moment at least.</p>
<p>The fine-tuning is done using profiles. A profile is just a
<a href="http://yaml.org/">YAML</a>file with some configuration information, so you
can give different projects different rule sets by giving them their own
configuration file. An example is:</p>
<p>[code]<br />
strictness: veryhigh<br />
ignore-paths: QA<br />
pylint:<br />
disable:<br />
- invalid-name<br />
- trailing-whitespace<br />
- too-few-public-methods<br />
[/code]</p>
<p>The really nice part is that configurations can inherit from other
configurations. For example, Prospector's different <code>--strictness</code>
options are really just different pre-defined profiles, and the example
above has been set up to inherit from the <code>--strictness high</code> profile.
The project-specific tweaks are:</p>
<ul>
<li>Ignore the directory called `QA` and its contents (which in this
    project contains temporary/intermediate files). This can also be
    achieved by using `--ignore-paths QA` on the command line.</li>
<li>Disable the `invalid-name` messages from Pylint.</li>
<li>Disable the `trailing-whitespace` messages from Pylint</li>
<li>Disable the `too-few-public-methods` messages from Pylint</li>
</ul>
<h2>Adding additional tools</h2>
<p>As well as the default tools (Pylint,
<a href="https://pypi.python.org/pypi/pep8">pep8</a>,
<a href="https://pypi.python.org/pypi/pyflakes">pyflakes</a>, mccabe,
<a href="https://github.com/landscapeio/dodgy">dodgy</a> and profile_validator),
additional tools can be turned on either via the command line or by
adding them to a profile. The useful extra options are:</p>
<ul>
<li><a href="https://pypi.python.org/pypi/pep257">pep257</a>, which checks that
    docstrings conform to the <a href="https://www.python.org/dev/peps/pep-0257/">PEP257 docstring conventions
    guide</a>. Use `--with-tool
    pep257` on the command line, or add `run: true` to a `pep257:`
    section in a profile file.</li>
<li><a href="https://pypi.python.org/pypi/vulture">vulture</a>, which checks for
    'dead code' (unused variables, functions, classes, etc.). This
    requires installation first, via `pip install
    prospector[with_vulture]`. (NB this syntax doesn't work in a <a href="http://zsh.sourceforge.net/">Z
    shell</a>.)</li>
<li><a href="https://pypi.python.org/pypi/pyroma">pyroma</a>, used for checking
    that Python packaging best practices are being followed. Requires
    `pip install prospector[with_pyroma]`. Note that using pyroma
    implies the use of pep257.</li>
</ul>
<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width < 768) ? "left" : align;
        indent = (screen.width < 768) ? "0em" : indent;
        linebreak = (screen.width < 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    var location_protocol = (false) ? 'https' : document.location.protocol;
    if (location_protocol !== 'http' && location_protocol !== 'https') location_protocol = 'https:';
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = location_protocol + '//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
    mathjaxscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>


        
    </div>
        <!-- /Content --> 

        <!-- Footer -->
        <div class="footer gradient-2">
            <div class="container footer-container ">
                <div class="row">
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Sitemap</div>
                        <ul class="list-unstyled">
                            <li><a href="/archives.html">Archives</a></li>
                            <li><a href="/tags.html">Tags</a></li>
                            <li><a href="/authors.html">Authors</a></li>
                        </ul>
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Social</div>
                        <ul class="list-unstyled">
                            <li><a href="https://twitter.com/@0x7df" target="_blank">Twitter</a></li>
                            <li><a href="https://github.com/0x7df" target="_blank">GitHub</a></li>
                            <li><a href="https://www.facebook.com/0x7df" target="_blank">Facebook</a></li>
                            <li><a href="https://stackoverflow.com/users/4802778" target="_blank">StackOverflow</a></li>
                            <li><a href="http://www.freecodecamp.com/0x7df" target="_blank">FreeCodeCamp</a></li>
                        </ul>
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Links</div>
                        <ul class="list-unstyled">
                            <li><a href="http://getpelican.com/" target="_blank">Pelican</a></li>
                            <li><a href="http://python.org/" target="_blank">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/" target="_blank">Jinja2</a></li>
                            <li><a href="https://github.com/barrysteyn/pelican_plugin-render_math" target="_blank">Maths plugin</a></li>
                            <li><a href="https://github.com/molivier/nest" target="_blank">Nest theme</a></li>
                            <li><a href="" target="_blank"></a></li>
                            <li><a href="" target="_blank"></a></li>
                            <li><a href="" target="_blank"></a></li>
                        </ul>
                    </div> 
                    <div class="col-xs-12 col-sm-3 col-md-3 col-lg-3">
                        <p class="pull-right text-right">
                            <small><em>Proudly powered by <a href="http://docs.getpelican.com/" target="_blank">pelican</a></em></small><br/>
                            <small><em>Theme and code by <a href="https://github.com/molivier" target="_blank">molivier</a></em></small><br/>
                            <small>&copy; 0x7df 2015</small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <!-- /Footer -->
    </body>
</html>